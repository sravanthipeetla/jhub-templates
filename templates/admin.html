{% extends "templates/page.html" %}
{% block stylesheet %}
{{ super() }}
<style>
  .navbar-collapse {
    margin: 1vw;
  }

  .navbar-default {
    background-color: #ffffff;
    border: none;
  }

  .navbar-default .navbar-nav>li>a {
    color: #000000;
    font-family: Poppins;
    font-size: 16px;
    font-weight: 500;
  }

  .navbar-default .navbar-text {
    color: #000000;
  }

  #jupyterhub-logo {
    height: 3.5vh;
    margin: 1.6vw;
  }

  .admin-container {
    padding-left: 12vw;
    padding-right: 12vw;
  }

  .admin-navbar {
    overflow: hidden;
  }

  /* Style the links inside the navigation bar */
  .admin-navbar a {
    float: left;
    display: block;
    color: #000000;
    text-align: center;
    padding: 1vw 4vw;
    text-decoration: none;
    font-size: 17px;
    border-bottom: 0.3vw solid #DBDBDB;
  }

  .admin-navbar a:hover {
    cursor: pointer;
  }

  .admin-navbar a.active {
    border-bottom: 0.3vw solid #006BB6;
    color: #006BB6;
  }

  .description-bar {
    display: flex;
    justify-content: space-between;
    padding-top: 1.5vw;
  }

  .description {
    font-family: Gothic A1;
    font-size: 16px;
    padding: 0.7vw;
  }

  .add-btn {
    border: none;
    background-color: #5FBEF0;
    width: 8vw;
    border-radius: 1.5vw;
    color: white;
    font-weight: 800;
    height: 2vw;
    font-size: 17px;
  }

  #admin-table {
    margin-bottom: 20px;
    background: #FFFFFF;
    border: 2px solid #5FBEF0;
    border-collapse: inherit;
    border-radius: 14px;
    table-layout: fixed;
    width: 100%;
  }

  #admin-thead {
    background: #D2EDFB;
    border-collapse: inherit;
    border-radius: 14px 14px 0px 0px;
    font-family: 'Poppins';
    font-size: 16px;
    font-weight: 600;
  }

  #admin-tbody {
    font-family: 'Gothic A1';
    font-size: 18px;
  }

  thead td:first-child {
    border-radius: 15px 0px 0px 0px;
  }

  tbody td:first-child {
    color: #006BB6;
  }

  td:last-child {
    border-radius: 0px 15px 0px 0px;
    text-align: left;
    padding: 5px 125px 5px 30px
  }

  td {
    padding: 5px 5px 5px 30px;
  }

  .delete_course_button {
    border: none;
    background-color: #ffffff;
  }

  #addCourseModal {
    display: none;
  }

  .courseModal {
    display: none;
    position: fixed;
    z-index: 2;
    padding-top: 100px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
  }

  .courseModalContent {
    background-color: #fefefe;
    margin: 9vh auto;
    padding: 20px;
    border: 1px solid #5FBEF0;
    width: 30%;
    border-radius: 15px;
    height: 27vh;
    box-shadow: 0px 2px 13px rgb(170 170 170 / 27%);
  }

  .courseClose {
    color: #000000;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .courseClose:hover,
  .courseClose:focus {
    color: #FF0000;
    text-decoration: none;
    cursor: pointer;
  }

  .column-flex {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: baseline;
  }

  .row-flex {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    gap: 2rem;
  }

  .row-flex-course {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    gap: 7rem;
  }

  #courseLabel,
  #instructorLabel {
    font-family: 'Gothic A1';
    font-style: normal;
    font-size: 2vh;
    line-height: 3vh;
    color: black;
    font-weight: 400 !important;
    margin: 4vh 0vw 2vh 1.5vw;
  }

  #cancel_course_button {
    background: white;
    border-radius: 41vh;
    border-color: #5FBEF0;
    margin: -2.8vh 0vw 0vh 15vw;
    font-family: 'Poppins';
    font-style: normal;
    font-size: 2vh;
    line-height: 2vh;
    color: #5FBEF0;
    width: 6vw;
    height: 3.9vh;
    position: absolute;
    border-width: 0.1vw !important;
    border-style: double;
  }

  #save_course_button {
    width: 6vw;
    height: 4vh;
    border-radius: 2vw;
    border: none;
    margin: 2vh -19vw 0vh 7vw;
    background-color: #D2EDFB;
    font-size: 1vw;
    font-weight: 100;
  }

  #addCourseModal input {
    border-radius: 41vh;
    border-color: #5FBEF0;
    border-width: 0.1vw !important;
    border-style: double;
    height: 3.5vh;
    width: 14vw;
  }
</style>
{% endblock %}
{% block main %}
<div id="react-admin-hook">
  <script id="jupyterhub-admin-config">
    window.api_page_limit = parseInt("{{ api_page_limit|safe }}")
    window.base_url = "{{ base_url|safe }}"
  </script>
  <script src={{ static_url("js/admin.js") }}></script>
  <div class="admin-container">
    <div class="admin-navbar">
      <a class="course-nav active" id="course-nav">Courses</a>
      <a class="instructor-nav" id="instructor-nav">Instructors</a>
      <a class="learner-nav" id="learner-nav">Learners</a>
      </ul>
    </div>
    <div class="description-bar">
      <p class="description">You can manage courses, instructors and learners from here.</p>
      <button class="add-btn"></button>
    </div>
    <table class="admin-table" id="admin-table">
      <thead id="admin-thead"></thead>
      <tbody id="admin-tbody"></tbody>
    </table>
    <div id="addCourseModal" class="modal">
      <div class="courseModalContent">
        <span class="courseClose">&times;</span>
        <div class="column-flex">
          <div class="row-flex-course">
            <div>
              <label id="courseLabel" for="course">Course name</label>
            </div>
            <div>
              <input type="text" id="course-name" />
            </div>
          </div>
          <div class="row-flex">
            <div>
              <label id="instructorLabel" for="instructor">Instructor username</label>
            </div>
            <div>
              <input type="text" id="instructor-user-name" />
            </div>
          </div>
          <div class="row-flex">
            <div>
              <button type="button" id="save_course_button">Save</button>
            </div>
            <div>
              <button type="button" id="cancel_course_button">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endblock %}

  {% block footer %}
  {% endblock %}

  {% block script %}
  {{ super() }}
  <script type="text/javascript">
    // require(["admin"]);
    // Copyright (c) Jupyter Development Team.
    // Distributed under the terms of the Modified BSD License.

    require(["jquery", "moment", "jhapi", "utils"], function (
      $,
      moment,
      JHAPI,
      utils
    ) {
      "use strict";

      var base_url = window.jhdata.base_url;
      var prefix = window.jhdata.prefix;
      var admin_access = window.jhdata.admin_access;
      var options_form = window.jhdata.options_form;

      var api = new JHAPI(base_url);

      function getRow(element) {
        var original = element;
        while (!element.hasClass("server-row")) {
          element = element.parent();
          if (element[0].tagName === "BODY") {
            console.error("Couldn't find row for", original);
            throw new Error("No server-row found");
          }
        }
        return element;
      }

      function resort(col, order) {
        var query = window.location.search.slice(1).split("&");
        // if col already present in args, remove it
        var i = 0;
        while (i < query.length) {
          if (query[i] === "sort=" + col) {
            query.splice(i, 1);
            if (query[i] && query[i].substr(0, 6) === "order=") {
              query.splice(i, 1);
            }
          } else {
            i += 1;
          }
        }
        // add new order to the front
        if (order) {
          query.unshift("order=" + order);
        }
        query.unshift("sort=" + col);
        // reload page with new order
        window.location = window.location.pathname + "?" + query.join("&");
      }

      $("th").map(function (i, th) {
        th = $(th);
        var col = th.data("sort");
        if (!col || col.length === 0) {
          return;
        }
        var order = th.find("i").hasClass("fa-sort-desc") ? "asc" : "desc";
        th.find("a").click(function () {
          resort(col, order);
        });
      });

      $(".time-col").map(function (i, el) {
        // convert ISO datestamps to nice momentjs ones
        el = $(el);
        var m = moment(new Date(el.text().trim()));
        el.text(m.isValid() ? m.fromNow() : "Never");
      });

      $(".stop-server").click(function () {
        var el = $(this);
        var row = getRow(el);
        var serverName = row.data("server-name");
        var user = row.data("user");
        el.text("stopping...");
        var stop = function (options) {
          return api.stop_server(user, options);
        };
        if (serverName !== "") {
          stop = function (options) {
            return api.stop_named_server(user, serverName, options);
          };
        }
        stop({
          success: function () {
            el.text("stop " + serverName).addClass("hidden");
            row.find(".access-server").addClass("hidden");
            row.find(".start-server").removeClass("hidden");
          },
        });
      });

      $(".delete-server").click(function () {
        var el = $(this);
        var row = getRow(el);
        var serverName = row.data("server-name");
        var user = row.data("user");
        el.text("deleting...");
        api.delete_named_server(user, serverName, {
          success: function () {
            row.remove();
          },
        });
      });

      $(".access-server").map(function (i, el) {
        el = $(el);
        var row = getRow(el);
        var user = row.data("user");
        var serverName = row.data("server-name");
        el.attr(
          "href",
          utils.url_path_join(prefix, "user", user, serverName) + "/"
        );
      });

      if (admin_access && options_form) {
        // if admin access and options form are enabled
        // link to spawn page instead of making API requests
        $(".start-server").map(function (i, el) {
          el = $(el);
          var row = getRow(el);
          var user = row.data("user");
          var serverName = row.data("server-name");
          el.attr(
            "href",
            utils.url_path_join(prefix, "hub/spawn", user, serverName)
          );
        });
        // cannot start all servers in this case
        // since it would mean opening a bunch of tabs
        $("#start-all-servers").addClass("hidden");
      } else {
        $(".start-server").click(function () {
          var el = $(this);
          var row = getRow(el);
          var user = row.data("user");
          var serverName = row.data("server-name");
          el.text("starting...");
          var start = function (options) {
            return api.start_server(user, options);
          };
          if (serverName !== "") {
            start = function (options) {
              return api.start_named_server(user, serverName, options);
            };
          }
          start({
            success: function () {
              el.text("start " + serverName).addClass("hidden");
              row.find(".stop-server").removeClass("hidden");
              row.find(".access-server").removeClass("hidden");
            },
          });
        });
      }

      $(".edit-user").click(function () {
        var el = $(this);
        var row = getRow(el);
        var user = row.data("user");
        var admin = row.data("admin");
        var dialog = $("#edit-user-dialog");
        dialog.data("user", user);
        dialog.find(".username-input").val(user);
        dialog.find(".admin-checkbox").attr("checked", admin === "True");
        dialog.modal();
      });

      $("#edit-user-dialog")
        .find(".save-button")
        .click(function () {
          var dialog = $("#edit-user-dialog");
          var user = dialog.data("user");
          var name = dialog.find(".username-input").val();
          var admin = dialog.find(".admin-checkbox").prop("checked");
          api.edit_user(
            user,
            {
              admin: admin,
              name: name,
            },
            {
              success: function () {
                window.location.reload();
              },
            }
          );
        });

      $(".delete-user").click(function () {
        var el = $(this);
        var row = getRow(el);
        var user = row.data("user");
        var dialog = $("#delete-user-dialog");
        dialog.find(".delete-username").text(user);
        dialog.modal();
      });

      $("#delete-user-dialog")
        .find(".delete-button")
        .click(function () {
          var dialog = $("#delete-user-dialog");
          var username = dialog.find(".delete-username").text();
          console.log("deleting", username);
          api.delete_user(username, {
            success: function () {
              window.location.reload();
            },
          });
        });

      $("#add-users").click(function () {
        var dialog = $("#add-users-dialog");
        dialog.find(".username-input").val("");
        dialog.find(".admin-checkbox").prop("checked", false);
        dialog.modal();
      });

      $("#add-users-dialog")
        .find(".save-button")
        .click(function () {
          var dialog = $("#add-users-dialog");
          var lines = dialog.find(".username-input").val().split("\n");
          var admin = dialog.find(".admin-checkbox").prop("checked");
          var usernames = [];
          lines.map(function (line) {
            var username = line.trim();
            if (username.length) {
              usernames.push(username);
            }
          });

          api.add_users(
            usernames,
            { admin: admin },
            {
              success: function () {
                window.location.reload();
              },
            }
          );
        });

      $("#stop-all-servers").click(function () {
        $("#stop-all-servers-dialog").modal();
      });

      $("#start-all-servers").click(function () {
        $("#start-all-servers-dialog").modal();
      });

      $("#stop-all-servers-dialog")
        .find(".stop-all-button")
        .click(function () {
          // stop all clicks all the active stop buttons
          $(".stop-server").not(".hidden").click();
        });

      function start(el) {
        return function () {
          $(el).click();
        };
      }

      $("#start-all-servers-dialog")
        .find(".start-all-button")
        .click(function () {
          $(".start-server")
            .not(".hidden")
            .each(function (i) {
              setTimeout(start(this), i * 500);
            });
        });

      $("#shutdown-hub").click(function () {
        var dialog = $("#shutdown-hub-dialog");
        dialog.find("input[type=checkbox]").prop("checked", true);
        dialog.modal();
      });

      $("#shutdown-hub-dialog")
        .find(".shutdown-button")
        .click(function () {
          var dialog = $("#shutdown-hub-dialog");
          var servers = dialog.find(".shutdown-servers-checkbox").prop("checked");
          var proxy = dialog.find(".shutdown-proxy-checkbox").prop("checked");
          api.shutdown_hub({
            proxy: proxy,
            servers: servers,
          });
        });
    });
    // custom script

    const ngshare_url = 'https://data-labs.hcl-edtech.com/services/ngshare/';
    const hub_url = 'https://data-labs.hcl-edtech.com/hub/api/';

    // To change the color for active link in top left navbar items
    const currentUrl = window.location.href.split("/");
    const currentAnchorTagText = currentUrl[currentUrl.length - 1];
    $('.navbar-nav a').each(function () {
      if ($(this).text().toLowerCase() == currentAnchorTagText) {
        $(this).css("color", "#006BB6");
      }
    });

    // To hide left navbar items - 'Token' and 'services'
    const navbar_left_list = document.getElementsByClassName("nav navbar-nav")[0].getElementsByTagName("li");
    navbar_left_list[1].style.visibility = 'hidden';
    navbar_left_list[3].style.visibility = 'hidden';

    // To change the color for active link in admin-navbar items
    $(".admin-navbar a").click((event) => {
      $(".admin-navbar .active").removeClass("active");
      $(event.target).addClass("active");
    });

    // Courses tab functionality
    const addCourseModal = document.getElementById("addCourseModal");
    const closeSpan = document.getElementsByClassName("courseClose")[0];
    const cancelCourseButton = document.getElementById("cancel_course_button");
    const saveCourseButton = document.getElementById("save_course_button");
    const courseNameText = document.getElementById("course-name");
    const instructorUserNameInput = document.getElementById("instructor-user-name");
    const addCourse = () => {
      console.log("here");
      addCourseModal.style.display = "block";
    }
    closeSpan.onclick = function () {
      addCourseModal.style.display = "none";
    }
    cancelCourseButton.onclick = function () {
      addCourseModal.style.display = "none";
    }

    saveCourseButton.onclick = ()=> {
      const courseName = courseNameText.value;
      const instructorUserName = instructorUserNameInput.value;
      if (courseName.length > 0 && instructorUserName.length > 0) {
        const coursePromise = fetch(`${ngshare_url}course/${courseName}`, {
          method: 'POST',
          headers: {
            Accept: 'application.json',
            'Content-Type': 'application/json'
          }
        });
        const courseReponse = coursePromise.json();
        if (courseResponse.status == 200 && response.ok) {
          const hubUsersListPromise= fetch(`${hub_url}/users`);
          const hubUsersList= hubUsersListPromise.json();
          for(const user in hubUsersList){
            if(user.name==instructorUserName && user.groups.include("instructor")){
              const instructorAddPromise = fetch(`${ngshare_url}instructor/${courseName}/${instructorUserName}?first_name=&last_name=&email=`, {
              method: 'POST',
              headers: {
                Accept: 'application.json',
                'Content-Type': 'application/json'
              }
            });
            }
          }
        }
      }
      else {
        alert('Please provide valid course name and instructor username');
        console.log(courseResponse);
      }
    }

    const deleteCourse = (courseName) => {
      console.log('here');
      console.log(courseName);
      // console.log(courseName);
    }
    //course-nav
    const fetchCourseDetails = async () => {
      $("#admin-thead tr").remove();
      $("#admin-table tr").remove();
      $(".add-btn").text("Add Course");
      $(".add-btn").attr('id', 'add-course');
      const addCourseButton = document.getElementById('add-course');
      const saveCourseButton = document.getElementById('save_course_button');
      addCourseButton.onclick = addCourse;
      $("#admin-thead").append('<tr><td>Course name</td><td>Instructor count</td><td>Learner count</td><td>Actions</td></tr>');
      const courseFetch = await fetch(`${ngshare_url}courses`);
      const courseJson = await courseFetch.json();
      const coursesList = courseJson.courses;
      coursesList.map(async (courseName) => {
        const instructorsPromise = await fetch(`${ngshare_url}instructors/${courseName}`);
        const instructorsJson = await instructorsPromise.json();
        const instructorsCount = instructorsJson.instructors.length;
        const studentsPromise = await fetch(`${ngshare_url}students/${courseName}`);
        const studentsJson = await studentsPromise.json();
        const studentsCount = studentsJson.students.length;
        const tr = '<tr><td>' + courseName + '</td><td>' + instructorsCount + '</td><td>' + studentsCount + '</td><td><button class="delete_course_button" id="delete_course_but" onclick="deleteCourse("'+course+'")"><img src="https://ik.imagekit.io/iwwbj9so6/Vector_SF-xac8QM.svg?ik-sdk-version=javascript-1.4.3&updatedAt=1668752579077"/></button></td></tr>';
        $("#admin-tbody").append(tr);
      })
    };

    const fetchInstructorDetails = async () => {
      $("#admin-thead tr").remove();
      $("#admin-table tr").remove();
      $(".add-btn").text("Add instructor");
      $(".add-btn").addClass("add-instructor");
      $("#admin-thead").append('<tr><td>Course name</td><td>Instructor count</td><td>Actions</td></tr>');
      const courseFetch = await fetch(`${ngshare_url}courses`);
      const courseJson = await courseFetch.json();
      const coursesList = courseJson.courses;
      coursesList.map(async (courseName) => {
        const instructorsPromise = await fetch(`${ngshare_url}instructors/${courseName}`);
        const instructorsJson = await instructorsPromise.json();
        const instructorsCount = instructorsJson.instructors.length;
        const tr = '<tr><td>' + courseName + '</td><td>' + instructorsCount + '</td><td><button><img src="https://ik.imagekit.io/iwwbj9so6/Vector_9_c4obhy8x5.png?ik-sdk-version=javascript-1.4.3&updatedAt=1660643960909"/></button></td></tr>';
        $("#admin-tbody").append(tr);
      });
    };

    const fetchLearnerDetails = async () => {
      $("#admin-thead tr").remove();
      $("#admin-table tr").remove();
      $(".add-btn").text("Add learner");
      $(".add-btn").addClass("add-learner");
      $("#admin-thead").append('<tr><td>Course name</td><td>Learner count</td><td>Actions</td></tr>');
      const courseFetch = await fetch(`${ngshare_url}courses`);
      const courseJson = await courseFetch.json();
      const coursesList = courseJson.courses;
      coursesList.map(async (courseName) => {
        const studentsPromise = await fetch(`${ngshare_url}students/${courseName}`);
        const studentsJson = await studentsPromise.json();
        const studentsCount = studentsJson.students.length;
        const tr = '<tr><td>' + courseName + '</td><td>' + studentsCount + '</td><td><button><img src="https://ik.imagekit.io/iwwbj9so6/Vector_9_c4obhy8x5.png?ik-sdk-version=javascript-1.4.3&updatedAt=1660643960909"/></button></td></tr>';
        $("#admin-tbody").append(tr);
      });
    };

    window.onload = fetchCourseDetails;
    const course_navigation = document.getElementById('course-nav');
    const instructor_navigation = document.getElementById('instructor-nav');
    const learner_navigation = document.getElementById('learner-nav');
    course_navigation.onclick = fetchCourseDetails;
    instructor_navigation.onclick = fetchInstructorDetails;
    learner_navigation.onclick = fetchLearnerDetails;
  </script>
  {% endblock %}