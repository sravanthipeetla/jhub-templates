{% extends "templates/page.html" %}
{% block stylesheet %}
{{ super() }}
<style>
  .navbar-collapse {
    margin: 1vw;
  }

  .navbar-default {
    background-color: #ffffff;
    border: none;
  }

  .navbar-default .navbar-nav>li>a {
    color: #000000;
    font-family: Poppins;
    font-size: 16px;
    font-weight: 500;
  }

  .navbar-default .navbar-text {
    color: #000000;
  }

  #jupyterhub-logo {
    height: 3.5vh;
    margin: 1.6vw;
  }

  .admin-container {
    padding-left: 12vw;
    padding-right: 12vw;
  }

  .admin-navbar {
    overflow: hidden;
  }

  /* Style the links inside the navigation bar */
  .admin-navbar a {
    float: left;
    display: block;
    color: #000000;
    text-align: center;
    padding: 1vw 4vw;
    text-decoration: none;
    font-size: 17px;
    border-bottom: 0.3vw solid #DBDBDB;
  }

  .admin-navbar a:hover {
    cursor: pointer;
  }

  .admin-navbar a.active {
    border-bottom: 0.3vw solid #006BB6;
    color: #006BB6;
  }

  .description-bar {
    display: flex;
    justify-content: space-between;
    padding-top: 1.5vw;
  }

  .description {
    font-family: Gothic A1;
    font-size: 16px;
    padding: 0.7vw;
  }

  #left-description-bar {
    display: flex;
    gap: 1rem;
  }

  .instructors_filter {
    display: none;
    border: 1px solid #5FBEF0;
    background-color: white;
    border-radius: 1.5vw;
    width: 8vw;
    height: 2vw;
    font-size: 17px;
    color: #000000;
    cursor: pointer;
    padding: 0.1vw;

  }

  .add-btn {
    display: none;
    border: none;
    background-color: #5FBEF0;
    width: 8vw;
    border-radius: 1.5vw;
    color: white;
    font-weight: 800;
    height: 2vw;
    font-size: 17px;
  }

  #admin-table {
    display: none;
    margin-bottom: 20px;
    background: #FFFFFF;
    border: 2px solid #5FBEF0;
    border-collapse: inherit;
    border-radius: 14px;
    table-layout: fixed;
    width: 100%;
  }

  #admin-thead {
    background: #D2EDFB;
    border-collapse: inherit;
    border-radius: 14px 14px 0px 0px;
    font-family: 'Poppins';
    font-size: 16px;
    font-weight: 600;
  }

  #admin-tbody {
    font-family: 'Gothic A1';
    font-size: 18px;
  }

  thead td:first-child {
    border-radius: 15px 0px 0px 0px;
  }

  tbody td:first-child {
    color: #006BB6;
  }

  td:last-child {
    border-radius: 0px 15px 0px 0px;
    text-align: left;
    padding: 5px 125px 5px 30px
  }

  td {
    padding: 5px 5px 5px 30px;
  }

  .delete_course_button,
  .dropdown_button {
    border: none;
    background-color: #ffffff;
  }

  #addCourseModal,
  #addStudentModal {
    display: none;
  }

  .courseModal {
    display: none;
    position: fixed;
    z-index: 2;
    padding-top: 100px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
  }

  .courseModalContent,
  .studentModalContent {
    background-color: #fefefe;
    margin: 9vh auto;
    padding: 20px;
    border: 1px solid #5FBEF0;
    width: 30%;
    border-radius: 15px;
    height: 27vh;
    box-shadow: 0px 2px 13px rgb(170 170 170 / 27%);
  }

  .courseClose,
  .studentClose {
    color: #000000;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .courseClose:hover,
  .courseClose:focus,
  .studentClose:hover,
  .studentClose:focus {
    color: #FF0000;
    text-decoration: none;
    cursor: pointer;
  }

  .column-flex {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: baseline;
  }

  .row-flex {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    gap: 2rem;
  }

  .row-flex-course {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    gap: 7rem;
  }

  #courseLabel,
  #instructorLabel {
    font-family: 'Gothic A1';
    font-style: normal;
    font-size: 2vh;
    line-height: 3vh;
    color: black;
    font-weight: 400 !important;
    margin: 4vh 0vw 2vh 1.5vw;
  }

  #cancel_course_button {
    background: white;
    border-radius: 41vh;
    border-color: #5FBEF0;
    margin: -2.8vh 0vw 0vh 15vw;
    font-family: 'Poppins';
    font-style: normal;
    font-size: 2vh;
    line-height: 2vh;
    color: #5FBEF0;
    width: 6vw;
    height: 3.9vh;
    position: absolute;
    border-width: 0.1vw !important;
    border-style: double;
  }

  #save_course_button {
    width: 6vw;
    height: 4vh;
    border-radius: 2vw;
    border: none;
    margin: 2vh -19vw 0vh 7vw;
    background-color: #5FBEF0;
    font-size: 1vw;
    font-weight: 100;
  }

  #addCourseModal input {
    border-radius: 41vh;
    border-color: #5FBEF0;
    border-width: 0.1vw !important;
    border-style: double;
    height: 3.5vh;
    width: 14vw;
  }

  div.fileinputs {
    position: relative;
    margin-left: 2vw;
  }

  div.fakefile {
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 1;
  }

  input.file {
    position: relative;
    text-align: right;
  }

  #file {
    margin: 2vh -2vw 0vh -1.2vw;
    width: 14vh;
    height: 6vh;
    cursor: pointer;
  }

  .select-div::after {
    content: url("https://ik.imagekit.io/iwwbj9so6/Vector_9_c4obhy8x5.png?ik-sdk-version=javascript-1.4.3&updatedAt=1660643960909");
  }

  .select-div {
    position: relative;
  }

  .select-div::after {
    position: absolute;
    top: 3.8vh;
    right: 8vw;
  }

  #file-upload-filename {
    margin-left: 4vw;
    margin-top: 3.5vh;
    color: #5fbef0;
  }

  .select {
    appearance: none;
    margin: 3vh 0vh 0vh 0vh;
    width: 13vw;
    height: 3.5vh;
    background: #ffffff;
    border: 0.1vw solid #5fbef0;
    border-radius: 8vh;
    font-family: "Poppins";
    font-style: normal;
    font-size: 2vh;
    padding: 0vh 0vw 0vh 0.9vw;
  }

  #fileinput {
    margin: 2vh -2vw 0vh -1.2vw;
    width: 14vh;
    height: 4vh;
    cursor: pointer;
  }

  .fake-input {
    border-width: 0.1vw !important;
    border-style: dashed;
    border-radius: 2vw;
    border-color: #5fbef0;
    margin: 2.5vh -2vw 0vh -1.2vw;
    width: 14vh;
    height: 3.7vh;
  }

  .upload-image {
    margin: -4vh;
    height: 1.7vh;
  }

  /* loader */
  .loader {
    border: 16px solid #f3f3f3;
    border-radius: 50%;
    border-top: 16px solid #3498db;
    width: 120px;
    height: 120px;
    margin: auto;
    -webkit-animation: spin 2s linear infinite;
    /* Safari */
    animation: spin 2s linear infinite;
  }

  /* Safari */
  @-webkit-keyframes spin {
    0% {
      -webkit-transform: rotate(0deg);
    }

    100% {
      -webkit-transform: rotate(360deg);
    }
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %}
{% block main %}
<div id="react-admin-hook">
  <script id="jupyterhub-admin-config">
    window.api_page_limit = parseInt("{{ api_page_limit|safe }}")
    window.base_url = "{{ base_url|safe }}"
  </script>
  <script src={{ static_url("js/admin.js") }}></script>
  <div class="admin-container">
    <div class="admin-navbar">
      <a class="course-nav active" id="course-nav">Courses</a>
      <a class="instructor-nav" id="instructor-nav">Instructors</a>
      <a class="learner-nav" id="learner-nav">Learners</a>
      </ul>
    </div>
    <div class="description-bar">
      <p class="description">You can manage courses, instructors and learners from here.</p>
      <div id="left-description-bar">
        <select class="instructors_filter" id="instructors_filter">
          <option default value="mapped">Mapped</option>
          <option value="unmapped">Unmapped</option>
          <option value="all">All</option>
        </select>
        <button class="add-btn"></button>
      </div>
    </div>
    <div class="loader"></div>
    <table class="admin-table" id="admin-table">
      <thead id="admin-thead"></thead>
      <tbody id="admin-tbody"></tbody>
    </table>
    <div id="addCourseModal" class="modal">
      <div class="courseModalContent">
        <span class="courseClose">&times;</span>
        <div class="column-flex">
          <div class="row-flex-course">
            <div>
              <label id="courseLabel" for="course">Course name</label>
            </div>
            <div>
              <input type="text" id="course-name" />
            </div>
          </div>
          <div class="row-flex">
            <div>
              <label id="instructorLabel" for="instructor">Instructor username</label>
            </div>
            <div>
              <input type="text" id="instructor-user-name" />
            </div>
          </div>
          <div class="row-flex">
            <div>
              <button type="button" id="cancel_course_button">Cancel</button>
            </div>
            <div>
              <button type="button" id="save_course_button">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="deleteCourseModal" class="modal">
      <div class="deletecourseModalContent">
        <span class="deletecourseClose">&times;</span>
        <div class="column-flex">
          <div class="row-flex-course">
            <span></span>
          </div>
          <div class="row-flex">
            <div>
              <button type="button" id="delete_course_button">Save</button>
            </div>
            <div>
              <button type="button" id="cancel_course_button">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endblock %}

  {% block footer %}
  {% endblock %}

  {% block script %}
  {{ super() }}
  <script type="text/javascript">
    // require(["admin"]);
//      console.log({{ base_url }});
    // custom script
//     const base_url={{ base_url }};
//     const hub_url = `${base_url}api/'`;
    const hub_url = 'https://data-labs.hcl-edtech.com/';
    console.log(window.location.href.split("/"));
    
    const ngshare_url = 'https://data-labs.hcl-edtech.com/services/ngshare/';

    // To change the color for active link in top left navbar items
    const currentUrl = window.location.href.split("/");
    const currentAnchorTagText = currentUrl[currentUrl.length - 1];
    $('.navbar-nav a').each(function () {
      if ($(this).text().toLowerCase() == currentAnchorTagText) {
        $(this).css("color", "#006BB6");
      }
    });

    // To hide left navbar items - 'Token' and 'services'
    const navbar_left_list = document.getElementsByClassName("nav navbar-nav")[0].getElementsByTagName("li");
    navbar_left_list[1].style.visibility = 'hidden';
    navbar_left_list[3].style.visibility = 'hidden';

    // To change the color for active link in admin-navbar items
    $(".admin-navbar a").click((event) => {
      $(".admin-navbar .active").removeClass("active");
      $(event.target).addClass("active");
    });

    // Courses tab functionality
    const addCourseModal = document.getElementById("addCourseModal");
    const closeSpan = document.getElementsByClassName("courseClose")[0];
    const cancelCourseButton = document.getElementById("cancel_course_button");
    const saveCourseButton = document.getElementById("save_course_button");
    const courseNameText = document.getElementById("course-name");
    const instructorUserNameInput = document.getElementById("instructor-user-name");
    const instructorsFilter = document.getElementById("instructors_filter");
    let courseNameSelected;
    let deleteCourseSelected;
    const addCourse = () => {
      addCourseModal.style.display = "block";
    }
    closeSpan.onclick = function () {
      addCourseModal.style.display = "none";
    }
    cancelCourseButton.onclick = function () {
      addCourseModal.style.display = "none";
    }

    saveCourseButton.onclick = async () => {
      const courseName = courseNameText.value;
      const instructorUserName = instructorUserNameInput.value;
      if (courseName.length > 0 && instructorUserName.length > 0) {
        const coursePromise = await fetch(`${ngshare_url}course/${courseName}`, {
          method: 'POST',
          headers: {
            Accept: 'application.json',
            'Content-Type': 'application/json'
          }
        });
        if (coursePromise.status == 200 && coursePromise.ok) {
          const hubAddUserPromise = await fetch(`${hub_url}users/${instructorUserName}`, {
            method: 'POST',
            headers: {
              Accept: 'application.json',
              'Content-Type': 'application/json'
            }
          });
          if (hubAddUserPromise.status == 201 && hubAddUserPromise.ok) {
            const data = {
              "users": [
                instructorUserName
              ]
            };
            const hubAddUserGroupPromise = await fetch(`${hub_url}groups/instructor/users`, {
              method: 'POST',
              headers: {
                Accept: 'application.json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            }
            );
            if (hubAddUserGroupPromise.status == 200 && hubAddUserGroupPromise.ok) {
              const instructorAddPromise = await fetch(`${ngshare_url}instructor/${courseName}/${instructorUserName}?first_name=&last_name=&email=`, {
                method: 'POST',
                headers: {
                  Accept: 'application.json',
                  'Content-Type': 'application/json'
                }
              });
              if (instructorAddPromise.status == 200 && instructorAddPromise.ok) {
                alert('Success created.');
                addCourseModal.style.display = "none";
                fetchCourseDetails();
              }
              else {
                const instructorAddResponse = await instructorAddPromise.json();
                alert(instructorAddResponse.message);
              }
            }
          }
          else {
            const hubAddUserResponse = await hubAddUserPromise.json();
            alert(hubAddUserResponse.message);
          }
        }
        else {
          const courseResponse = await coursePromise.json();
          alert(courseResponse.message);
        }
      }
      else {
        alert('Please provide valid course name and instructor username');
      }
    }
    const deleteCourse = async (courseSelected) => {

      const courseDeletePromise = await fetch(`${ngshare_url}course/${courseSelected}`, {
        method: 'DELETE',
        headers: {
          Accept: 'application.json',
          'Content-Type': 'application/json'
        }
      });
      const response = await courseDeletePromise.json();
      if (response.success) {
        alert("Successfully deleted course");
        fetchCourseDetails();
      }
      else {
        alert("Something went wrong! Couldn't delete course");
      }
    }

    //course-nav
    const fetchCourseDetails = async () => {
      const getCourseDetails = async (courses) => {
        const details = courses.map(async (courseName) => {
          const instructorsPromise = await fetch(`${ngshare_url}instructors/${courseName}`);
          const instructorsJson = await instructorsPromise.json();
          const instructorsCount = instructorsJson.instructors.length;
          const studentsPromise = await fetch(`${ngshare_url}students/${courseName}`);
          const studentsJson = await studentsPromise.json();
          const studentsCount = studentsJson.students.length;
          return { 'courseName': courseName, 'instructorsCount': instructorsCount, 'studentsCount': studentsCount };
        });
        return Promise.all(details);
      }
      let courseDetails = [];
      const courseFetch = await fetch(`${ngshare_url}courses`);
      const courseJson = await courseFetch.json();
      const coursesList = courseJson.courses;
      (async () => {
        courseDetails = await getCourseDetails(coursesList);
        if (courseDetails.length != 0) {
          document.getElementsByClassName('loader')[0].style.display = 'none';
          document.getElementById('admin-table').style.display = 'inline-table';
          document.getElementsByClassName('add-btn')[0].style.display = 'block';
          $("#admin-thead tr").remove();
          $("#admin-table tr").remove();
          $(".add-btn").text("Add Course");
          $(".add-btn").attr('id', 'add-course');
          instructorsFilter.style.display = 'none';
          const addCourseButton = document.getElementById('add-course');
          const saveCourseButton = document.getElementById('save_course_button');
          addCourseButton.onclick = addCourse;
          $("#admin-thead").append('<tr><td>Course name</td><td>Instructor count</td><td>Learner count</td><td>Actions</td></tr>');
          courseDetails.map((detail) => {
            const tr = `<tr><td>${detail.courseName}</td><td>${detail.instructorsCount}</td><td>${detail.studentsCount}</td><td><button type='button' class="delete_course_button" id=${detail.courseName} onclick="deleteCourse(this.id)" ><img src="https://ik.imagekit.io/iwwbj9so6/Vector_SF-xac8QM.svg?ik-sdk-version=javascript-1.4.3&updatedAt=1668752579077" /></button></td></tr>`;
            $("#admin-tbody").append(tr);
          });
        }
        else {
          document.getElementsByClassName('loader')[0].style.display = 'block';

        }
      })();
    };


    const fetchInstructorDetails = async () => {
      let courseInstructor = {};
      let instructorCourse = {};
      const getInstructorDetails = async (courses, instructorsUsername) => {
        const details = courses.map(async (courseName) => {
          const instructorsPromise = await fetch(`${ngshare_url}instructors/${courseName}`);
          const instructorsJson = await instructorsPromise.json();
          const instructorsData = await instructorsJson.instructors;
          let instructorList = [];
          for (let i = 0; i < instructorsData.length; i++) {
            instructorList.push(instructorsData[i].username);
            if (instructorsUsername.indexOf(instructorsData[i].username) === -1) {
              instructorsUsername.push(instructorsData[i].username);
            }
          };
          courseInstructor[courseName] = instructorList;
          for (let i = 0; i < instructorsUsername.length; i++) {
            for (let key in courseInstructor) {
              if (courseInstructor[key].includes(instructorsUsername[i])) {
                if (Object.keys(instructorCourse).indexOf(instructorsUsername[i]) === -1) {
                  instructorCourse[instructorsUsername[i]] = [key];
                }
                else {
                  if (instructorCourse[instructorsUsername[i]].indexOf(key) === -1)
                    instructorCourse[instructorsUsername[i]].push(key);
                }
              }
            }
          };
          return instructorCourse;
        });
        return Promise.all(details);
      };
      let instructorDetails = [];
      const courseFetch = await fetch(`${ngshare_url}courses`);
      const courseJson = await courseFetch.json();
      const coursesList = courseJson.courses;
      const hubUsersFetch = await fetch(`${hub_url}users`);
      const hubUsersJson = await hubUsersFetch.json();
      const instructorsUsername = [];
      for (let i = 0; i < hubUsersJson.length; i++) {
        if (hubUsersJson[i].groups.includes('instructor')) {
          instructorsUsername.push(hubUsersJson[i].name);
        }
      }
      (async () => {
        instructorDetails = await getInstructorDetails(coursesList, instructorsUsername);
        if (instructorDetails.length != 0) {
          document.getElementsByClassName('loader')[0].style.display = 'none';
          document.getElementById('admin-table').style.display = 'inline-table';
          document.getElementsByClassName('add-btn')[0].style.display = 'block';
          $("#admin-thead tr").remove();
          $("#admin-table tr").remove();
          $(".add-btn").text("Add Instructor");
          $(".add-btn").attr('id', 'add-instructor');
          instructorsFilter.style.display = 'none';
          const addCourseButton = document.getElementById('add-instructor');
          // const saveCourseButton = document.getElementById('save_course_button');
          // addCourseButton.onclick = addCourse;
          $("#admin-thead").append('<tr><td>Instructor Username</td><td>Course count</td><td>Actions</td></tr>');
          for (const [key, value] of Object.entries(instructorDetails.at(-1))) {
            const tr = `<tr><td>${key}</td><td>${value.length}</td><td><button class="dropdown_button" id=${value}><img src="https://ik.imagekit.io/iwwbj9so6/Vector_9_c4obhy8x5.png?ik-sdk-version=javascript-1.4.3&updatedAt=1660643960909"/></button></td></tr>`;
            $("#admin-tbody").append(tr);
            // value.map((val) => {
            //       trs.push(`<tr><td>${val}</td><td></td><td><button class="dropdown_button" id=${val}+${key}><img src="https://ik.imagekit.io/iwwbj9so6/Vector_9_c4obhy8x5.png?ik-sdk-version=javascript-1.4.3&updatedAt=1660643960909"/></button></td></tr>`);
            // });
          }
        }
        else {
          document.getElementsByClassName('loader')[0].style.display = 'block';
        }
      })();
    };


    const fetchLearnerDetails = async () => {
      $("#admin-thead tr").remove();
      $("#admin-table tr").remove();
      instructorsFilter.style.display = 'block';
      $(".add-btn").text("Add learner");
      // $(".add-btn").addClass("addStudentBtn");
      instructorsFilter.style.display = 'none';
      $("#admin-thead").append('<tr><td>Course name</td><td>Learner count</td><td>Actions</td></tr>');
      const courseFetch = await fetch(`${ngshare_url}courses`);
      const courseJson = await courseFetch.json();
      const coursesList = courseJson.courses;
      coursesList.map(async (courseName) => {
        const studentsPromise = await fetch(`${ngshare_url}students/${courseName}`);
        const studentsJson = await studentsPromise.json();
        let studentsUsername = [];
        for (let i = 0; i < studentsJson.students.length; i++) {
          studentsUsername.push(studentsJson.students[i].username);
        }
        console.log(studentsUsername);
        const studentsCount = studentsJson.students.length;
        const tr = '<tr><td>' + courseName + '</td><td>' + studentsCount + '</td><td><button class="dropdown_button"><img src="https://ik.imagekit.io/iwwbj9so6/Vector_9_c4obhy8x5.png?ik-sdk-version=javascript-1.4.3&updatedAt=1660643960909"/></button></td></tr>';
        $("#admin-tbody").append(tr);
      });
    };

    window.onload = fetchCourseDetails;
    const course_navigation = document.getElementById('course-nav');
    const instructor_navigation = document.getElementById('instructor-nav');
    const learner_navigation = document.getElementById('learner-nav');
    course_navigation.onclick = fetchCourseDetails;
    instructor_navigation.onclick = fetchInstructorDetails;
    learner_navigation.onclick = fetchLearnerDetails;
  </script>
  {% endblock %}
